<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Command Palette (02) — Keyboard + A11y</title>

  <!-- HTMX via CDN for a drop-in HTMX artifact. [5] -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>

  <style>
    :root{
      --primary-hue: 210;
      --primary: hsl(var(--primary-hue) 60% 55%);
      --on-surface: hsl(var(--primary-hue) 15% 92%);
      --on-surface-variant: hsl(var(--primary-hue) 10% 70%);
      --surface-container-lowest: hsl(var(--primary-hue) 15% 9%);
      --surface-container-low: hsl(var(--primary-hue) 14% 12%);
      --surface-container: hsl(var(--primary-hue) 14% 14%);
      --surface-container-high: hsl(var(--primary-hue) 14% 17%);
      --shadow: 0 18px 45px rgba(0,0,0,.55), 0 2px 10px rgba(0,0,0,.38);
      --r-xl: 20px;
      --r-lg: 16px;
      --r-md: 12px;
      --transition-fast: 150ms cubic-bezier(.4,0,.2,1);
      --transition-base: 300ms cubic-bezier(.4,0,.2,1);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:22px;
      font-family: var(--sans);
      background: radial-gradient(circle at top left, var(--surface-container-lowest) 0, #000 100%);
      color: var(--on-surface);
    }
    .wrap{max-width:980px; margin:0 auto;}
    .zone{background: var(--surface-container-low); border-radius: var(--r-xl); box-shadow: var(--shadow); padding: 16px;}

    .head{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
    h1{font-size:16px; margin:0;}
    .sub{margin:6px 0 0 0; color:var(--on-surface-variant); font-size:13px; line-height:1.4;}
    .pill{font-family: var(--mono); font-size:11px; color:var(--on-surface-variant); background: color-mix(in srgb, var(--surface-container-high) 70%, transparent); padding:3px 8px; border-radius:999px; white-space:nowrap;}

    .palette{margin-top: 14px; background: var(--surface-container); border-radius: var(--r-xl); padding: 12px;}

    .inputRow{display:flex; align-items:center; gap:10px; background: var(--surface-container-high); border-radius: 999px; padding: 10px 12px;}
    .kbd{font-family: var(--mono); font-size:11px; color:var(--on-surface-variant); padding: 2px 8px; border-radius: 999px; background: color-mix(in srgb, var(--surface-container) 70%, transparent);}
    .search{flex:1; border:0; outline:none; background: transparent; color: var(--on-surface); font-size: 13px;}
    .search::placeholder{color: color-mix(in srgb, var(--on-surface-variant) 80%, transparent)}

    .metaRow{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px;}
    .hint{font-size:12px; color: var(--on-surface-variant);}

    .results{margin-top: 10px; border-radius: var(--r-lg); background: var(--surface-container-low); padding: 8px; max-height: 360px; overflow:auto;}
    .groupTitle{font-size:11px; color: var(--on-surface-variant); font-family: var(--mono); padding: 10px 10px 6px 10px;}

    .item{display:flex; align-items:center; justify-content:space-between; gap:10px; padding: 10px; border-radius: var(--r-md); background: transparent; cursor:pointer; transition: background var(--transition-base), transform var(--transition-fast); user-select:none; outline:none;}
    .item:hover{background: var(--surface-container-high); transform: translateY(-1px);}
    .item[aria-selected="true"]{background: color-mix(in srgb, var(--primary) 14%, var(--surface-container-high));}

    .left{display:flex; align-items:center; gap:10px; min-width:0;}
    .icon{width:26px;height:26px;border-radius:10px;background: color-mix(in srgb, var(--primary) 14%, transparent); display:grid; place-items:center; font-weight:800; color: var(--primary);}
    .label{font-size:13px; font-weight:650; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .desc{font-size:12px; color: var(--on-surface-variant); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .shortcut{font-family: var(--mono); font-size:11px; color: var(--on-surface-variant);}

    .empty{padding: 16px; color: var(--on-surface-variant); font-size: 12px; text-align:center;}
    .out{margin-top: 12px; background: var(--surface-container); border-radius: var(--r-xl); padding: 12px; color: var(--on-surface-variant); font-size: 12px; min-height: 48px;}

    .srOnly{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="zone">
      <div class="head">
        <div>
          <h1>Command (02) — Keyboard + A11y</h1>
          <p class="sub">
            Demonstrates keyboard-first navigation and ARIA combobox/listbox wiring, including focus continuity across swaps. [4]
          </p>
        </div>
        <div class="pill">Arrow keys • Enter • Escape</div>
      </div>

      <div class="palette">
        <!-- Combobox pattern: input controls listbox, with aria-activedescendant -->
        <div class="inputRow">
          <span class="kbd">Esc</span>
          <input id="q" class="search" type="text" autocomplete="off" placeholder="Type a command…"
                 role="combobox"
                 aria-expanded="true"
                 aria-controls="listbox"
                 aria-autocomplete="list"
                 aria-activedescendant=""
                 hx-get="/fake/command/search"
                 hx-trigger="keyup changed delay:120ms"
                 hx-target="#listbox"
                 hx-swap="innerHTML" />
          <span class="kbd">↑↓</span>
          <span class="kbd">↵</span>
        </div>

        <div class="metaRow">
          <div class="hint">Keys: Up/Down moves selection • Enter runs • Escape clears query</div>
          <div class="hint"><span class="kbd">Tab</span> stays in input for this demo</div>
        </div>

        <div class="srOnly" aria-live="polite" id="srStatus"></div>

        <div class="results" id="listbox" role="listbox" aria-label="Command results">
          <!-- rendered by script + HTMX fake backend -->
        </div>
      </div>

      <div class="out" id="out">No command executed yet.</div>
    </div>
  </div>

  <script>
    const COMMANDS = [
      { id: 'nav.home', group: 'Navigation', label: 'Go to Home', desc: 'Navigate to the home screen', icon: 'N', shortcut: 'H' },
      { id: 'nav.settings', group: 'Navigation', label: 'Open Settings', desc: 'Open settings page', icon: 'N', shortcut: 'S' },
      { id: 'theme.dark', group: 'Appearance', label: 'Theme: Dark', desc: 'Switch to dark theme tokens', icon: 'A', shortcut: 'D' },
      { id: 'theme.light', group: 'Appearance', label: 'Theme: Light', desc: 'Switch to light theme tokens', icon: 'A', shortcut: 'L' },
      { id: 'help.docs', group: 'Help', label: 'Open Docs', desc: 'Open documentation', icon: '?', shortcut: 'H' },
      { id: 'help.shortcuts', group: 'Help', label: 'Keyboard Shortcuts', desc: 'View all shortcuts', icon: '?', shortcut: '?' },
    ];

    let activeIndex = 0;

    function escapeHtml(s){
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }

    function scoreMatch(q, text){
      q = (q||'').toLowerCase().trim();
      text = (text||'').toLowerCase();
      if(!q) return 1;
      let ti = 0;
      for(const ch of q){
        ti = text.indexOf(ch, ti);
        if(ti === -1) return 0;
        ti++;
      }
      return Math.max(0.2, q.length / Math.max(1, text.length));
    }

    function filterCommands(q){
      return COMMANDS
        .map(c => ({ c, s: Math.max(scoreMatch(q, c.label), scoreMatch(q, c.desc), scoreMatch(q, c.id)) }))
        .filter(x => x.s > 0)
        .sort((a,b) => b.s - a.s)
        .map(x => x.c);
    }

    function renderList(items){
      if(!items.length) return `<div class="empty">No results.</div>`;

      const byGroup = new Map();
      for(const it of items){
        if(!byGroup.has(it.group)) byGroup.set(it.group, []);
        byGroup.get(it.group).push(it);
      }

      let flat = [];
      let html = '';
      for(const [group, rows] of byGroup){
        html += `<div class="groupTitle">${escapeHtml(group)}</div>`;
        for(const it of rows){
          const optionId = `opt-${escapeHtml(it.id)}`;
          flat.push({ ...it, optionId });
          html += `
            <div class="item" id="${optionId}" role="option" aria-selected="false" tabindex="-1"
                 data-cmd="${escapeHtml(it.id)}"
                 hx-post="/fake/command/run"
                 hx-vals='{"id":"${escapeHtml(it.id)}"}'
                 hx-target="#out"
                 hx-swap="innerHTML">
              <div class="left">
                <div class="icon" aria-hidden="true">${escapeHtml(it.icon)}</div>
                <div style="min-width:0">
                  <div class="label">${escapeHtml(it.label)}</div>
                  <div class="desc">${escapeHtml(it.desc)}</div>
                </div>
              </div>
              <div class="shortcut">${escapeHtml(it.shortcut)}</div>
            </div>
          `;
        }
      }
      return { html, flat };
    }

    let currentFlat = [];

    function setActive(i){
      if(!currentFlat.length) {
        document.getElementById('q').setAttribute('aria-activedescendant','');
        return;
      }
      activeIndex = Math.max(0, Math.min(i, currentFlat.length - 1));

      // Update aria-selected.
      document.querySelectorAll('#listbox .item[role="option"]').forEach((el) => {
        el.setAttribute('aria-selected','false');
      });

      const active = currentFlat[activeIndex];
      const el = document.getElementById(active.optionId);
      if(el){
        el.setAttribute('aria-selected','true');
        // Ensure visibility.
        el.scrollIntoView({ block: 'nearest' });
        // Activedescendant remains on input.
        document.getElementById('q').setAttribute('aria-activedescendant', active.optionId);
        document.getElementById('srStatus').textContent = `Selected ${active.label}`;
      }
    }

    function rerender(){
      const q = document.getElementById('q').value;
      const items = filterCommands(q);
      const r = renderList(items);
      document.getElementById('listbox').innerHTML = r.html;
      currentFlat = r.flat;
      setActive(0);
    }

    // Initial render.
    rerender();

    // Keyboard nav.
    document.getElementById('q').addEventListener('keydown', (e) => {
      if(e.key === 'ArrowDown'){ e.preventDefault(); setActive(activeIndex + 1); }
      if(e.key === 'ArrowUp'){ e.preventDefault(); setActive(activeIndex - 1); }
      if(e.key === 'Enter'){
        e.preventDefault();
        const active = currentFlat[activeIndex];
        if(!active) return;
        const el = document.getElementById(active.optionId);
        el && el.click();
      }
      if(e.key === 'Escape'){
        e.preventDefault();
        document.getElementById('q').value = '';
        rerender();
      }
    });

    // Re-render on input, but keep focus in the input for continuity.
    document.getElementById('q').addEventListener('input', () => rerender());

    // Fake HTMX backend for run; search rendering is client-side here.
    document.body.addEventListener('htmx:configRequest', (evt) => {
      const path = evt.detail.path || evt.detail.requestConfig?.path;
      if(!path || !path.startsWith('/fake/')) return;
      evt.preventDefault();

      const elt = evt.detail.elt;
      const targetSel = elt?.getAttribute('hx-target');
      const target = targetSel ? document.querySelector(targetSel) : null;

      setTimeout(() => {
        if(path.startsWith('/fake/command/run')){
          const vals = JSON.parse(elt.getAttribute('hx-vals') || '{}');
          const id = vals.id || 'unknown';
          if(target) target.innerHTML = `<div><strong style="color:var(--on-surface)">Ran</strong> <span style="font-family:var(--mono)">${escapeHtml(id)}</span></div>`;
          // Focus stays in input.
          document.getElementById('q').focus();
        }
      }, 120);
    });
  </script>
</body>
</html>
